<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">@twist/babel-plugin-transform/src/transforms/DecoratorImportTransform.js | Twist</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="React... with a twist!"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Twist"><meta property="twitter:description" content="React... with a twist!"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/adobe/twist"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#babel-plugin-transform-src-transforms">babel-plugin-transform/src/transforms</a><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DecoratorDefinition">DecoratorDefinition</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-src">core/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/BaseStore.jsx~BaseStore.html">BaseStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/Binder.jsx~Binder.html">Binder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/CollectionBinder.jsx~CollectionBinder.html">CollectionBinder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/Disposable.jsx~Disposable.html">Disposable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/ObjectId.jsx~ObjectId.html">ObjectId</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/ObservableArray.jsx~ObservableArray.html">ObservableArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/ObservableMap.jsx~ObservableMap.html">ObservableMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/ObservableSet.jsx~ObservableSet.html">ObservableSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/Scope.jsx~Scope.html">Scope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/Signal.jsx~Signal.html">Signal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/SignalDispatcher.jsx~SignalDispatcher.html">SignalDispatcher</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-src-decorators">core/src/decorators</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/core/src/decorators/State.jsx~State.html">State</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Abstract">Abstract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Bind">Bind</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Cache">Cache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Debounce">Debounce</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Delay">Delay</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Memoize">Memoize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Observable">Observable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Prototype">Prototype</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Throttle">Throttle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Wrap">Wrap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-state">state</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-src-middleware">core/src/middleware</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-protectorMiddleware">protectorMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-remoteDevMiddleware">remoteDevMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-thunkMiddleware">thunkMiddleware</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#react-src">react/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/react/src/BaseComponent.jsx~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/@twist/react/src/BaseVirtualComponent.jsx~BaseVirtualComponent.html">BaseVirtualComponent</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">@twist/babel-plugin-transform/src/transforms/DecoratorImportTransform.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/*
 *  Copyright 2017 Adobe Systems Incorporated. All rights reserved.
 *  This file is licensed to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 *  you may not use this file except in compliance with the License. You may obtain a copy
 *  of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software distributed under
 *  the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
 *  OF ANY KIND, either express or implied. See the License for the specific language
 *  governing permissions and limitations under the License.
 *
 */

const PathUtils = require(&apos;../PathUtils&apos;);
const t = require(&apos;babel-types&apos;);

module.exports = class DecoratorImporter {

    /**
     * @typedef {object} DecoratorDefinition
     * @property {string} module
     *   The module from which to import the decorator.
     * @property {string?} export
     *   The export name from `module`; if not provided, &quot;default&quot; is assumed.
     * @property {{ module: string, export: string }} inherits
     *   If provided, import the superclass defined by module/export and make the decorated class inherit from it.
     * @property {boolean?} needsClassName
     *   If true, the name of the class will be passed as the first extra argument to the decorator (after `target`).
     * @property {boolean?} interceptsSuper
     *   If true, add a class in between the given class and its superclass. (Used to dynamically
     *   insert methods into the class.)
     * @property {string?} hotReload
     *   If true, insert the HotReload decorator from this path (used by @Component).
     *
     * For legacy reasons, the following variants are supported:
     *   - `inherits` may be a string (implies `{ module: ___, export: &apos;default&apos; }`).
     *   - A plain string, or a definition containing `classPath` or `path`, will be converted properly.
     */

    /**
     * Load a bunch of decorator definitions.
     * @param {{ decoratorName: DecoratorDefinition }} definitions
     */
    constructor(definitions) {
        this.definitions = {};
        for (let name in definitions) {
            let dec = definitions[name];
            this.definitions[name] = {
                module: dec.module || dec.classPath || dec.path || dec,
                export: dec.export || &apos;default&apos;,
                inherits: typeof dec.inherits === &apos;string&apos; ? { module: dec.inherits, export: &apos;default&apos; } : dec.inherits,
                needsClassName: dec.needsClassName,
                interceptsSuper: dec.interceptsSuper,
                hotReload: dec.hotReload,
            };
        }
    }

    /**
     * Automatically import decorators referenced from this file, matching the provided definitions.
     * Traverse each decorator via the Program node to ensure that this plugin runs in a deterministic order.
     */
    traverseProgram(path) {
        path.traverse({
            &apos;ClassExpression|ClassDeclaration|ClassProperty|Method&apos;: (path) =&gt; {
                if (path.node.decorators) {
                    path.node.decorators.forEach((decorator, index) =&gt; {
                        this.visitDecorator(path.get(&apos;decorators.&apos; + index), path);
                    });
                }
            },
        });
    }

    /** Sanity-check the syntax of decorator import definitions. */
    assertDefinitionFormat(def, decoratorName) {
        if (!def || !def.module || !def.export) {
            throw new Error(`DecoratorImporter received an invalid definition for @${decoratorName
            }. Expected an object with &quot;module&quot; and &quot;export&quot; string keys; got ${JSON.stringify(def)}`);
        }
        if (def.inherits) {
            if (!def.inherits.module || !def.inherits.export) {
                throw new Error(`DecoratorImporter received an invalid definition for @${decoratorName
                }&apos;s &quot;inherits&quot; property. Expected an object with &quot;module&quot; and &quot;export&quot;; got ${JSON.stringify(def)}`);
            }
        }
    }

    /** Given this decorator, automatically import the necessary module(s). */
    visitDecorator(decoratorPath, path) {
        const decorator = decoratorPath.node;
        const identifier = DecoratorImporter.getLeftmostIdentifier(decorator.expression);

        // First, check that the decorator isn&apos;t already imported
        if (decoratorPath.scope.hasBinding(identifier.name)) {
            return;
        }

        // Look up the decorator to see if it should be imported automatically
        const def = this.definitions[identifier.name];
        if (!def) {
            // A decorator with no definition. This is fine; they might have imported a decorator manually.
            return;
        }
        this.assertDefinitionFormat(def, identifier.name);

        // Change the name to the import, but also remember the original name - because some of the other transforms may need to know this!
        decoratorPath.setData(&apos;originalName&apos;, identifier.name);
        identifier.name = PathUtils.addImportOnce(path, def.export, def.module).name;

        const className = t.isClass(path.node) &amp;&amp; path.node.id.name;

        if (def.inherits &amp;&amp; !path.node.superClass) {
            path.node.superClass = PathUtils.addImportOnce(path, def.inherits.export, def.inherits.module);
        }

        if (def.needsClassName) {
            if (!t.isCallExpression(decorator.expression)) {
                decorator.expression = t.callExpression(decorator.expression, []);
            }
            decorator.expression.arguments.unshift(t.stringLiteral(className));
        }
        if (def.hotReload &amp;&amp; className) {
            decorator.expression = t.callExpression(PathUtils.addImportOnce(path, &apos;default&apos;, def.hotReload),
                [ decorator.expression, t.identifier(&apos;module&apos;), t.stringLiteral(className) ]);
        }
        if (def.interceptsSuper) {
            // We need to put an empty class between this class and it&apos;s parent. That&apos;s needed for classes like import that will use
            // the intercept class to inject more methods as they are received from a different thread.
            const oldSuperClass = path.node.superClass;
            path.node.superClass = path.scope.generateUidIdentifier(className + &apos;SuperIntercept&apos;);

            // Queue the new class for conversion.
            path.requeue(path.getStatementParent().insertBefore([ t.classDeclaration(path.node.superClass, oldSuperClass, t.classBody([]), []) ])[0]);
        }
    }

    /** Given a decorator expression, find the root identifier -- the one we want to import. */
    static getLeftmostIdentifier(node) {
        switch (node.type) {
        case &apos;CallExpression&apos;: return DecoratorImporter.getLeftmostIdentifier(node.callee);
        case &apos;ArrayExpression&apos;: return DecoratorImporter.getLeftmostIdentifier(node.elements[0]);
        case &apos;MemberExpression&apos;: return DecoratorImporter.getLeftmostIdentifier(node.object);
        case &apos;Identifier&apos;: return node;
        default: throw new Error(`DecoratorImporter.getLeftmostIdentifier() doesn&apos;t know what &apos;${node.type}&apos; is.`);
        }
    }
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
